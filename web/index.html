<!DOCTYPE HTML>
<html>
	<head>
		<meta charset="utf-8">
		<title>Coreborn Community Resource Map</title>
		<style type="text/css" media="screen">
			html, body {
				height: 100%;
			}
			body {
				display: flex;
				background-color: #181e25;
				padding:0px;
				margin:0px;
			}
			canvas {
			}
			.row {
				display: flex;
				flex-direction: row;
			}
			.column {
				display: flex;
				flex-direction: column;
			}
			.align-center {
				display: flex;
				align-items: center;
				justify-content: center;
			}
			.menu {
				color: #FFFFFF;
				overflow-y: auto;
				min-width: 15rem;
			}
			.menu-entry {

			}
			.filter-checkbox {
				padding-left: 0.5rem;
				padding-right: 0.5rem;
				cursor: pointer;
			}
			.filter-label {
				font-size: 2rem;
				padding: 1rem;
				flex-grow: 1;
				text-transform: capitalize; 
			}
			.filter-add-new-dot {
				background-color: #7BB950;
				font-size: 2rem;
				font-weight: bold;
				padding: 1rem;
				cursor: pointer;
			}
			.container {
				position: relative;
				flex-grow: 1;
				overflow: hidden;
			}
			.header {
				font-size: 2rem;
				background-color: #C2C2C2;
				text-transform: capitalize;
			}
			.footer-start {
				font-size: 1rem;
				margin-top: auto;
				cursor: pointer;
				padding-bottom: 1rem;
			}
			.footer-end {
				font-size: 1rem;
				cursor: pointer;
				padding-bottom: 1rem;
			}
			input[type=checkbox] {
				cursor: pointer;
			}
		</style>
		<script type="text/javascript" charset="utf-8">
			let config = {};
			let canvas = null;
			let ctx = null;
			let map_image = null;
			let map_width = null;
			let map_height = null;
			let map_scale = 1.0;
			let length_of_diagonal = null;
			let cursor_pos = {x: 0, y: 0};
			let current_add = null;
			let current_category = null;
			let mouse_motion_render = null;
			let mouse_position_history = [];
			const dot_radius = 5;

			let resources = {}
			zones = {
				'western_flowerwood' : {
					'color' : '#0CA789',
					'positions' : [
						{x: 0.49537643659666775, y: 0.2624193294834353},
						{x: 0.5008577802934496, y: 0.25145664208987145},
						{x: 0.5029132841797429, y: 0.24186429062050305},
						{x: 0.5008577802934496, y: 0.23090160322693917},
						{x: 0.5118204676870135, y: 0.2281609313785482},
						{x: 0.5289496667394571, y: 0.2295312673027437},
						{x: 0.5405975220951187, y: 0.22747576341645045},
						{x: 0.545393697829803, y: 0.21925374787127755},
						{x: 0.5460788657919007, y: 0.20897622843981142},
						{x: 0.55841188910966, y: 0.21240206825030014},
						{x: 0.5632080648443443, y: 0.22679059545435273},
						{x: 0.5714300803895171, y: 0.23364227507533014},
						{x: 0.5817075998209833, y: 0.24323462654469855},
						{x: 0.5858186075935697, y: 0.2583083217108489},
						{x: 0.5871889435177652, y: 0.2754375207632924},
						{x: 0.576911424086299, y: 0.28023369649797664},
						{x: 0.5741707522379081, y: 0.2877705440810518},
						{x: 0.5680042405790284, y: 0.29393705573993145},
						{x: 0.5659487366927352, y: 0.3062700790576908},
						{x: 0.5515602094886826, y: 0.3076404149818863},
						{x: 0.5447085298677051, y: 0.29667772758832245},
						{x: 0.539912354133021, y: 0.28365953630846535},
						{x: 0.5262089948910661, y: 0.2761226887253902},
						{x: 0.5152463074975022, y: 0.2699561770665105},
						{x: 0.49537643659666775, y: 0.2624193294834353}
					]
				},
				'eastern_flowerwood' : {
					'color' : '#0CA789',
					'positions' : [
						{x: 0.5597822250338556, y: 0.21308723621239786},
						{x: 0.5714300803895171, y: 0.21719824398498433},
						{x: 0.5817075998209833, y: 0.20760589251561593},
						{x: 0.5988367988734268, y: 0.1986987090083453},
						{x: 0.6091143183048929, y: 0.2151427400986911},
						{x: 0.6091143183048929, y: 0.23227193915113467},
						{x: 0.6145956620016749, y: 0.2521418100519692},
						{x: 0.6248731814331411, y: 0.25488248190036017},
						{x: 0.6413172125234868, y: 0.25351214597616467},
						{x: 0.6529650678791484, y: 0.24734563431728498},
						{x: 0.6522798999170507, y: 0.2603638255971421},
						{x: 0.6522798999170507, y: 0.2699561770665105},
						{x: 0.6522798999170507, y: 0.28365953630846535},
						{x: 0.651594731954953, y: 0.3069552470197886},
						{x: 0.6413172125234868, y: 0.3179179344133525},
						{x: 0.6317248610541185, y: 0.3042145751713976},
						{x: 0.6241880134710432, y: 0.29393705573993145},
						{x: 0.6118549901532839, y: 0.2884557120431495},
						{x: 0.5995219668355246, y: 0.29462222370202923},
						{x: 0.5858186075935697, y: 0.30010356739881117},
						{x: 0.5741707522379081, y: 0.31175142275447276},
						{x: 0.566633904654833, y: 0.3062700790576908},
						{x: 0.5700597444653216, y: 0.29462222370202923},
						{x: 0.5755410881621036, y: 0.2891408800052473},
						{x: 0.5782817600104946, y: 0.28228920038426986},
						{x: 0.5871889435177652, y: 0.2768078566874879},
						{x: 0.5865037755556675, y: 0.2583083217108489},
						{x: 0.5830779357451787, y: 0.24529013043099177},
						{x: 0.5728004163137126, y: 0.2343274430374279},
						{x: 0.5597822250338556, y: 0.21308723621239786},
						{x: 0.5597822250338556, y: 0.21308723621239786}
					]
				},
				'lonely_fields' : {
					'color' : '#FEF445',
					'positions' : [
						{x: 0.6611870834243214, y: 0.29462222370202923},
						{x: 0.6591315795380281, y: 0.2768078566874879},
						{x: 0.6550205717654417, y: 0.26447483336972855},
						{x: 0.6584464115759304, y: 0.2555676498624579},
						{x: 0.6632425873106146, y: 0.24803080227938273},
						{x: 0.6742052747041785, y: 0.25625281782455567},
						{x: 0.6879086339461333, y: 0.25488248190036017},
						{x: 0.6988713213396972, y: 0.25282697801406695},
						{x: 0.6920196417187198, y: 0.271326512990706},
						{x: 0.6947603135671108, y: 0.2829743683463676},
						{x: 0.6995564893017949, y: 0.29667772758832245},
						{x: 0.6899641378324266, y: 0.29393705573993145},
						{x: 0.6611870834243214, y: 0.29462222370202923}
					]
				},
				'the_gilded_yearn' : {
					'color' : '#F4FF2f',
					'positions' : [
						{x: 0.35971318010131476, y: 0.3028442392472021},
						{x: 0.3473801567835554, y: 0.29736289555042017},
						{x: 0.3473801567835554, y: 0.28708537611895407},
						{x: 0.3384729732762847, y: 0.2747523528011947},
						{x: 0.3302509577311118, y: 0.2761226887253902},
						{x: 0.3186031023754502, y: 0.27064134502860826},
						{x: 0.30832558294398404, y: 0.26721550521811954},
						{x: 0.3062700790576908, y: 0.2541973139382624},
						{x: 0.29530739166412695, y: 0.26310449744553305},
						{x: 0.2905112159294428, y: 0.2754375207632924},
						{x: 0.27886336057378114, y: 0.2891408800052473},
						{x: 0.27064134502860826, y: 0.2877705440810518},
						{x: 0.26790067318021726, y: 0.27954852853587886},
						{x: 0.2617341615213376, y: 0.28160403242217213},
						{x: 0.25625281782455567, y: 0.2726968489149015},
						{x: 0.2439197945067963, y: 0.27954852853587886},
						{x: 0.2343274430374279, y: 0.27954852853587886},
						{x: 0.2247350915680595, y: 0.2740671848390969},
						{x: 0.22542025953015724, y: 0.26447483336972855},
						{x: 0.23364227507533014, y: 0.2576231537487511},
						{x: 0.24117912265840533, y: 0.25625281782455567},
						{x: 0.24323462654469855, y: 0.24323462654469855},
						{x: 0.25351214597616467, y: 0.24871597024148048},
						{x: 0.26584516929392404, y: 0.24597529839308951},
						{x: 0.28023369649797664, y: 0.25351214597616467},
						{x: 0.2905112159294428, y: 0.24666046635518726},
						{x: 0.3062700790576908, y: 0.24049395469630758},
						{x: 0.3233992781101344, y: 0.2425494585826008},
						{x: 0.3329916295795028, y: 0.24117912265840533},
						{x: 0.337787805314187, y: 0.25351214597616467},
						{x: 0.3412136451246757, y: 0.2617341615213376},
						{x: 0.35697250825292376, y: 0.2569379857866534},
						{x: 0.3624538519497057, y: 0.26927100910441276},
						{x: 0.37136103545697635, y: 0.2740671848390969},
						{x: 0.3638241878739012, y: 0.2829743683463676},
						{x: 0.3665648597222922, y: 0.2884557120431495},
						{x: 0.37204620341907413, y: 0.292566719815736},
						{x: 0.37410170730536735, y: 0.29804806351251795},
						{x: 0.3603983480634125, y: 0.3035294072092999},
						{x: 0.35765767621502154, y: 0.3035294072092999},
						{x: 0.35765767621502154, y: 0.3035294072092999}
					]
				},
				'graveyard' : {
					'color' : '#9F4F4F',
					'positions' : [
						{x: 0.35354666844243504, y: 0.20006904493254077},
						{x: 0.3603983480634125, y: 0.19595803715995433},
						{x: 0.3672500276843899, y: 0.1925321973494656},
						{x: 0.37478687526746507, y: 0.18842118957687914},
						{x: 0.380268218964247, y: 0.19321736531156336},
						{x: 0.3898605704336154, y: 0.1973283730841498},
						{x: 0.3823237228505402, y: 0.20075421289463852},
						{x: 0.37067586749487863, y: 0.20280971678093174},
						{x: 0.35354666844243504, y: 0.20966139640190917},
						{x: 0.35354666844243504, y: 0.20006904493254077},
						{x: 0.35354666844243504, y: 0.20006904493254077},
						{x: 0.35354666844243504, y: 0.20006904493254077}
					]
				},
				'debug' : {
					'color' : '#FF44FF',
					'positions' : [
						
					]
				}
			}

			let debug = [];

			function load_map_image() {
				map_image = this;
				render()
			}

			function load_config() {
				return new Promise((resolve, reject) => {
					fetch('/config.json', {
						method: 'GET',
						headers: {
							'Accept': 'application/json',
						},
					})
					.then(response => response.json())
					.then((data) => {
						config = data
						resolve()
					})
				})
			}

			function load_resources() {
				fetch(`https://${config.api.host}${config.api.prefix}/resources/*`, {
					method: 'GET',
					headers: {
						'Accept': 'application/json',
					},
				})
				.then(response => response.json())
				.then((data) => {
					//console.log(data)
					resources = data
					load_filters()
					render()
				})
			}

			function resizeImage(img, width, height) {
				return new Promise((resolve, reject) => {
					const resized_image = document.createElement('canvas')
					const resize_context = resized_image.getContext("2d")

					const ratio = img.width / img.height

					if (width < img.width || height < img.height) {
						if(width / img.width >= height / img.height) {
							resized_image.height = height
							resized_image.width = resized_image.height * ratio
						} else {
							resized_image.width = width
							resized_image.height = resized_image.width / ratio
						}
					} else {
						if(width / img.width <= height / img.height) {
							resized_image.width = width
							resized_image.height = resized_image.width / ratio
						} else {
							resized_image.height = height
							resized_image.width = ratio * resized_image.height
						}
					}

					const p_width = Math.min(width, img.width) / Math.max(width, img.width)
					const p_height = Math.min(height, img.height) / Math.max(height, img.height)

					// https://stackoverflow.com/questions/3862096/2d-coordinate-normalization
					length_of_diagonal = Math.sqrt((resized_image.width) * (resized_image.width) + (resized_image.height) * (resized_image.height))

					if (p_width > p_height) {
						map_scale = p_height * ratio
					} else {
						map_scale = p_width * ratio
					}

					resize_context.drawImage(img, 0, 0, resized_image.width, resized_image.height)
					//console.log(`Map scale is: ${map_scale}`)

					resolve({'img' : resized_image, 'width' : resized_image.width, 'height' : resized_image.height})
				})
			}

			function render(area = null) {
				if (area !== null) {
					if (area.x < 0)
						area.x = 0
					if (area.y < 0)
						area.y = 0
				}
				if(map_image) {
					resizeImage(map_image, map_width, map_height)
					.then((blob) => {
						ctx.clearRect(area?.x ? area.x : 0, area?.y ? area.y : 0, area?.width ? area.width : map_width, area?.height ? area.height : map_height);
						ctx.filter = "grayscale(80%)";
						ctx.drawImage(
							blob['img'],
							area?.x ? area.x : 0,
							area?.y ? area.y : 0,
							area?.width ? area.width : blob['width'],
							area?.height ? area.height : blob['height'],
							area?.x ? area.x : 0,
							area?.y ? area.y : 0,
							area?.width ? area.width : blob['width'],
							area?.height ? area.height : blob['height'],
						)
						ctx.filter = "grayscale(0%)";
					})
					.then(() => {
						// Render the zones
						if(document.querySelector('.zones-checkbox')?.checked) {
							Object.keys(zones).forEach((region) => {
								let start = null;
								let cp1 = null;
								let cp2 = null;
								let end = null;
								let center = {
									x: 0,
									y: 0
								}

								ctx.beginPath();
								ctx.strokeStyle = zones[region]?.color ? zones[region].color : '#000000';
								ctx.lineWidth = 2;

								zones[region]['positions'].forEach((pos) => {
									if (!start)
										start = pos
									else if(!cp1)
										cp1 = pos
									else if (!end)
										end = pos

									center.x += pos.x
									center.y += pos.y

									if(end) {
										ctx.moveTo(start.x * length_of_diagonal, start.y * length_of_diagonal);

										ctx.quadraticCurveTo(
											cp1.x * length_of_diagonal,
											cp1.y * length_of_diagonal,
											end.x * length_of_diagonal,
											end.y * length_of_diagonal
										)

										start = end
										cp1 = null
										end = null
									}
								})
								ctx.stroke()

								center.x = center.x / zones[region]['positions'].length
								center.y = center.y / zones[region]['positions'].length

								ctx.moveTo(center.x * length_of_diagonal, center.y * length_of_diagonal)
								ctx.font = "1vw serif"
								ctx.textAlign = 'center'
								ctx.fillStyle = zones[region]?.color ? zones[region].color : '#000000'
								ctx.strokeStyle = '#000000'

								const zone_text = region.split('_').map((item) => {return item[0].toUpperCase() + item.substring(1)}).join(' ')
	  							ctx.strokeText(zone_text, center.x * length_of_diagonal, center.y * length_of_diagonal)
	  							ctx.fillText(zone_text, center.x * length_of_diagonal, center.y * length_of_diagonal)
							})
						}
					})
					.then(() => {
						debug.forEach((pos) => {
							let x = pos[0] * length_of_diagonal
							let y = pos[1] * length_of_diagonal

							ctx.fillStyle = "#FFABD0";
							ctx.beginPath();
							ctx.arc(x, y, dot_radius, 0, 2 * Math.PI);
							ctx.fill();
						})

						Object.keys(resources).forEach((category) => {
							Object.keys(resources[category]).forEach((resource) => {
								if (config.resources[resource].visible) {
									let dots_in_area = false;

									ctx.beginPath();
									ctx.fillStyle = resources[category][resource]['color'];
									ctx.strokeStyle = '#000000';
									ctx.lineWidth = 2;

									resources[category][resource]['positions']?.forEach((pos) => {
										let x = pos.x * length_of_diagonal
										let y = pos.y * length_of_diagonal

										if(area === null || (x + dot_radius >= area.x && x - dot_radius <= area.x + area.width && y + dot_radius >= area.y && y - dot_radius <= area.y + area.height)) {
											ctx.moveTo(x, y);
											ctx.arc(x, y, dot_radius, 0, 2 * Math.PI);
											dots_in_area = true;
										}
									})

									if(dots_in_area) {
										ctx.stroke();
										ctx.fill();
									}
								}
							})
						})
					})
					.then(() => {
						if(current_add) {
							normalized_X = cursor_pos.x / length_of_diagonal
							normalized_Y = cursor_pos.y / length_of_diagonal

							let x = cursor_pos.x * length_of_diagonal
							let y = cursor_pos.y * length_of_diagonal

							ctx.beginPath();
							ctx.fillStyle = resources[current_category][current_add]['color'];
							ctx.strokeStyle = '#000000';
							ctx.lineWidth = 2;
							ctx.arc(x, y, dot_radius, 0, 2 * Math.PI);
							ctx.stroke();
							ctx.fill();
						}
					})
				}
			}

			window.onresize = (event) => {
				canvas.width = document.querySelector('.container').scrollWidth - document.querySelector('.menu').scrollWidth
				canvas.height = document.querySelector('.container').scrollHeight

				map_width = canvas.width
				map_height = canvas.height

				render()
			}

			window.onload = () => {
				canvas = document.querySelector('.map')
				canvas.width = document.querySelector('.container').scrollWidth - document.querySelector('.menu').scrollWidth
				canvas.height = document.querySelector('.container').scrollHeight

				map_width = canvas.width
				map_height = canvas.height

				ctx = canvas.getContext('2d')

				const image = new Image()
				image.onload = load_map_image
				image.src = "/map.png";

				canvas.addEventListener('click', (event) => {
					const click = {
						x: event.layerX,
						y: event.layerY
					}

					normalized_X = click.x / length_of_diagonal
					normalized_Y = click.y / length_of_diagonal

					/*zones.debug.positions.push(
						{x: normalized_X, y: normalized_Y}
					)

					if(zones.debug.positions.length % 5 == 0)
						render()*/

					if(
						current_add
						&& normalized_X >= 0.030541382493515543
						&& normalized_X <= 0.7774170089258502
						&& normalized_Y >= 0.0749652115749927
						&& normalized_Y <= 0.5101799121075892
					) {
						// #FFABD0
						//dots.push([click.x, click.y])
						fetch(`https://${config.api.host}${config.api.prefix}/resources/${current_add}`, {
							method: 'PUT',
							headers: {
								'Content-Type': 'application/json'
							},
							body: JSON.stringify({"x": normalized_X, "y": normalized_Y})
						})
						debug.push([normalized_X, normalized_Y])
						// console.log(JSON.stringify(debug))
						load_resources()
					}
				})

				canvas.addEventListener('mousemove', (event) => {
					cursor_pos = {
						x: event.layerX / length_of_diagonal,
						y: event.layerY / length_of_diagonal
					}

					if(map_image && current_add) {
						if(mouse_motion_render)
							clearTimeout(mouse_motion_render)

						mouse_motion_render = setTimeout(() => {
							mouse_position_history.forEach((cord, index) => {
								render({
									x: (cord.x * length_of_diagonal) - (dot_radius+2),
									y: (cord.y * length_of_diagonal) - (dot_radius+2),
									width: (dot_radius+2)*2,
									height: (dot_radius+2)*2
								});
								mouse_position_history.splice(index, 1)
							})
							mouse_position_history.push({'x': cursor_pos.x, 'y': cursor_pos.y});
						}, 1)
					}
				})

				load_config()
				.then(() => {
					load_resources()
				})
			}

			function checkbox_category(div, value) {
				div.querySelectorAll('input[type=checkbox]')?.forEach((input) => {
					if(input.hasAttribute('resource')) {
						const resource = input.getAttribute('resource');

						config.resources[resource].visible = value
						input.checked = value
					}
				})
			}

			function load_filters() {
				let menu = document.querySelector('.menu');
				menu.innerHTML = '';

				let zones_div = document.createElement('div')
				zones_div.classList = 'zones'

				let zone_header = document.createElement('div')
				zone_header.classList = 'menu-entry row header'

				const filter_zones = document.createElement('div')
				filter_zones.classList = 'filter-checkbox align-center'

				const zones_checkbox = document.createElement('input')
				zones_checkbox.type = 'checkbox'
				zones_checkbox.classList = 'zones-checkbox'
				zones_checkbox.checked = config?.zones?.visible ? config.zones.visible : false

				const zones_label = document.createElement('div')
				zones_label.classList = 'filter-label'
				zones_label.innerText = 'Zones'

				filter_zones.appendChild(zones_checkbox)
				zone_header.appendChild(filter_zones)
				zone_header.appendChild(zones_label);

				filter_zones.addEventListener('click', (event) => {
					if(event.srcElement == filter_zones) {
						zones_checkbox.checked = zones_checkbox.checked ? false : true
					}
					render()
				})

				zones_div.appendChild(zone_header)
				menu.appendChild(zones_div)

				Object.keys(resources).forEach((category) => {
					let category_div = document.createElement('div')
					category_div.classList = 'category'

					let header = document.createElement('div')
					header.classList = 'menu-entry row header'

					const filter_category = document.createElement('div')
					filter_category.classList = 'filter-checkbox align-center'

					const category_checkbox = document.createElement('input')
					category_checkbox.type = 'checkbox'
					category_checkbox.classList = 'category-checkbox'
					category_checkbox.checked = true

					const category_label = document.createElement('div')
					category_label.classList = 'filter-label'
					category_label.innerText = category

					filter_category.appendChild(category_checkbox)
					header.appendChild(filter_category)
					header.appendChild(category_label);

					filter_category.addEventListener('click', (event) => {
						if(event.srcElement == filter_category) {
							category_checkbox.checked = category_checkbox.checked ? false : true
						}
						checkbox_category(category_div, category_checkbox.checked)
						render()
					})

					category_div.appendChild(header)

					Object.keys(resources[category]).forEach((resource) => {
						const menu_entry = document.createElement('div')
						menu_entry.classList = 'menu-entry row'

						const filter_checkbox = document.createElement('div')
						filter_checkbox.classList = 'filter-checkbox align-center'
						filter_checkbox.style.backgroundColor = resources[category][resource]['color']

						const filter_label = document.createElement('div')
						filter_label.classList = 'filter-label align-center'

						const add_new_dot = document.createElement('div')
						add_new_dot.classList = 'filter-add-new-dot align-center'

						const checkbox = document.createElement('input')
						checkbox.type = 'checkbox'
						checkbox.checked = config.resources[resource].visible
						checkbox.setAttribute('resource', resource)

						filter_label.innerText = resource

						add_new_dot.innerText = '+'

						filter_checkbox.appendChild(checkbox)
						menu_entry.appendChild(filter_checkbox)
						menu_entry.appendChild(filter_label)
						menu_entry.appendChild(add_new_dot)

						add_new_dot.addEventListener('click', () => {
							current_add = resource
							current_category = category
						})
						filter_checkbox.addEventListener('click', (event) => {
							if(event.srcElement == filter_checkbox) {
								checkbox.checked = checkbox.checked ? false : true
							}
							config.resources[resource].visible = checkbox.checked
							render()
						})

						category_div.appendChild(menu_entry)
					})

					menu.appendChild(category_div)
				})


				let source = document.createElement('div')
				source.classList = 'menu-entry row footer-start align-center'
				source.innerText = 'Source Code (GitHub)'

				source.addEventListener('click', () => {
					window.open('https://github.com/Torxed/coreborn', '_blank').focus();
				})

				menu.appendChild(source)

				let footer = document.createElement('div')
				footer.classList = 'menu-entry row footer-end align-center'
				footer.innerText = 'https://coreborn.gg/ (Official Website)'

				footer.addEventListener('click', () => {
					window.open('https://coreborn.gg/', '_blank').focus();
				})

				menu.appendChild(footer)
			}
		</script>
	</head>
	<body>
		<div class="menu column">
			
		</div>
		<div class="container">
			<canvas width="10" height="10" class="map"></canvas>
		</div>
	</body>
</html>